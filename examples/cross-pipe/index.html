<!doctype html>

<head>
    <meta charset="utf8">
    <title>Cross Pipe</title>
    <link rel="icon" href="#">
    <link rel="stylesheet" href="../index.css">
</head>

<body>
    <script type="module">
        import * as THREE from "https://unpkg.com/three@0.121.1/build/three.module.js"
        import { OrbitControls } from "https://unpkg.com/three@0.121.1/examples/jsm/controls/OrbitControls"
        import Modeller from "../../src/index.js";

        // ----
        // Boot
        // ----

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(45, 2, .1, 100);
        const controls = new OrbitControls(camera, renderer.domElement);
        window.addEventListener('resize', () => {
            const { clientWidth, clientHeight } = renderer.domElement;
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(clientWidth, clientHeight, false);
            camera.aspect = clientWidth / clientHeight;
            camera.updateProjectionMatrix();
        });
        document.body.prepend(renderer.domElement);
        window.dispatchEvent(new Event('resize'));
        renderer.setAnimationLoop(() => {
            renderer.render(scene, camera);
            controls.update();
        });

        // ----
        // Main
        // ----

        scene.background = new THREE.Color("white");
        camera.position.set(5, 5, 5);
        controls.autoRotate = true;
        scene.add(new THREE.HemisphereLight("white", "powderblue"));

        // +----
        // Demo: Re-assigning `mesh.material` doesn't affect already-created models
        // which using this mesh. But, mutating likes `mesh.material.color.set()` does.  
        // +----

        const mesh = new THREE.Mesh(
            new THREE.CylinderBufferGeometry(1, 1, 3),
            new THREE.MeshLambertMaterial({ color: "blue" })
        );

        const modeller = new Modeller(THREE);
       
        // ----
        // Part 1: Make outer cross pipe model. (in blue)
        // ----

        // A upright cylinder model.
        const modelVerticalPipeOuter = modeller.model(mesh);

        // A horizontal cylinder model.
        mesh.rotation.z = Math.PI / 2;
        const modelHorizontalPipeOuter = modeller.model(mesh);

        // A cross pipe solid model.
        const modelCrossPipeOuter = modelVerticalPipeOuter.union(modelHorizontalPipeOuter);

        // ----
        // Part 2: Make inner cross pipe model. (in red)
        // ----

        // Change mesh material. Note that we are **re-assigning** a new material 
        // to mesh, s.t. this modification only affects subsequent models.
        mesh.material = new THREE.MeshLambertMaterial({ color: "red" });

        // A upright down-scaled cylinder model.
        mesh.rotation.z = 0;
        mesh.scale.set(0.9, 1.0, 0.9);
        const modelVerticalPipeInner = modeller.model(mesh);

        // A horizontal down-scaled cylinder model.
        mesh.rotation.z = Math.PI / 2;
        const modelHorizontalPipeInner = modeller.model(mesh);

        // A down-scaled cross pipe model.
        const modelCrossPipeInner = modelVerticalPipeInner.union(modelHorizontalPipeInner);

        // ----
        // Part 3: Subtract outer from inner.
        // ----

        const modelCrossPipe = modelCrossPipeOuter.subtract(modelCrossPipeInner);

        // Build mesh and add it to scene.
        scene.add(modelCrossPipe.build());
    </script>
</body>